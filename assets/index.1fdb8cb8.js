var P=Object.defineProperty;var S=Object.getOwnPropertySymbols;var C=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable;var I=(e,r,a)=>r in e?P(e,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[r]=a,f=(e,r)=>{for(var a in r||(r={}))C.call(r,a)&&I(e,a,r[a]);if(S)for(var a of S(r))E.call(r,a)&&I(e,a,r[a]);return e};import{s as W}from"./side-effect-manager.es.5f289aa4.js";import{e as L}from"./ensure-attributes.2c659353.js";function y(e){return typeof e=="object"&&e!==null}var R=`.netless-app-embedded-page{width:100%;height:100%;position:relative}.netless-app-embedded-page iframe{width:100%;height:100%;border:none;display:block}.netless-app-embedded-page-wb-view{width:100%;height:100%;position:absolute;top:0;left:0}
`;const G=new Set(["clicker","selector"]),V={kind:"EmbeddedPage",setup(e){const r=e.getDisplayer(),a=e.getRoom(),h=e.getBox(),c=e.getView(),o=L(e,{src:"https://example.org",state:{},page:""}),l=new W,p=document.createElement("div");p.dataset.appKind="EmbeddedPage",p.classList.add("netless-app-embedded-page");const b=document.createElement("iframe");p.appendChild(b),h.mountStyles(R),h.mountContent(p);function v(s){return s===void 0?s:JSON.parse(JSON.stringify(s))}function u(s){return s.map(({memberId:t,payload:n})=>({sessionUID:t,uid:(a==null?void 0:a.uid)||(n==null?void 0:n.uid)||"",userPayload:v(n)}))}const d=s=>{var t;(t=b.contentWindow)==null||t.postMessage(s,"*")};if(c){const s=document.createElement("div");if(s.classList.add("netless-app-embedded-page-wb-view"),p.appendChild(s),e.mountView(s),a){const t=n=>{s.style.pointerEvents=!n||G.has(n)?"none":"auto"};t(a.state.memberState.currentApplianceName),l.add(()=>{const n=i=>{i.memberState&&t(i.memberState.currentApplianceName),i.roomMembers&&d({type:"RoomMembersChanged",payload:u(i.roomMembers)})};return a.callbacks.on("onRoomStateChanged",n),()=>a.callbacks.off("onRoomStateChanged",n)})}}const g=`channel-${e.appId}`;l.add(()=>{const s=t=>{t.event===g&&t.authorId!==r.observerId&&d({type:"ReceiveMessage",payload:t.payload})};return r.addMagixEventListener(g,s),()=>r.removeMagixEventListener(g)});const M=()=>{var n;const s=r.observerId,t=(n=r.state.roomMembers.find(i=>i.memberId===s))==null?void 0:n.payload;d({type:"Init",payload:{state:o.state,page:o.page,writable:e.getIsWritable(),roomMembers:u(r.state.roomMembers),meta:{sessionUID:s,uid:(a==null?void 0:a.uid)||(t==null?void 0:t.uid)||"",roomUUID:a==null?void 0:a.uuid,userPayload:v(t)}}})};l.addEventListener(window,"message",s=>{if(s.source!==b.contentWindow||!y(s.data))return;const t=s.data;switch(console.log("[EmbeddedPage] receive",t),t.type){case"Init":{M();break}case"GetState":{d({type:"GetState",payload:o.state});break}case"SetState":{if(y(t.payload)&&e.getIsWritable())for(const[n,i]of Object.entries(t.payload))e.updateAttributes(["state",n],i);break}case"GetPage":{d({type:"GetPage",payload:o.page});break}case"SetPage":{if(!c)console.warn("[EmbeddedPage] SetPage: page api is only available with 'scenePath'");else{const n=t.payload,i=e.getInitScenePath();if(typeof n=="string"&&e.getIsWritable()&&i&&a){const m=[i,n].join("/");a.scenePathType(m)==="none"&&a.putScenes(i,[{name:n}]),e.setScenePath(m),e.updateAttributes(["page"],n)}}break}case"GetWritable":{d({type:"GetWritable",payload:e.getIsWritable()});break}case"SendMessage":{e.getIsWritable()&&a&&a.dispatchMagixEvent(g,t.payload);break}case"MoveCamera":{y(t.payload)&&c&&c.moveCamera({centerX:t.payload.x,centerY:t.payload.y,scale:t.payload.scale,animationMode:"immediately"});break}case"GetRoomMembers":{d({type:"GetRoomMembers",payload:u(r.state.roomMembers)});break}}}),l.add(()=>{let s=f({},o.state);const t=i=>{const m={};for(const{key:w,value:k}of i)m[w]={oldValue:s[w],newValue:k};s=f({},o.state),d({type:"StateChanged",payload:m})},n=()=>e.objectUtils.listenUpdated(o.state,t);return e.mobxUtils.reaction(()=>o.state,n,{fireImmediately:!0})}),l.add(()=>{const s=(t,n)=>{d({type:"PageChanged",payload:{oldValue:n,newValue:t}})};return e.mobxUtils.reaction(()=>o.page,s)}),l.add(()=>{let s=e.getIsWritable();const t=()=>{const n=e.getIsWritable();d({type:"WritableChanged",payload:{oldValue:s,newValue:n}}),s=n};return e.emitter.on("writableChange",t),()=>e.emitter.off("writableChange",t)}),b.src=o.src,e.emitter.on("destroy",()=>{console.log("[EmbeddedPage]: destroy"),l.flushAll()})}};export{V as default};
