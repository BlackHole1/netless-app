var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,i=(t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n,o=(e,t)=>{for(var r in t||(t={}))s.call(t,r)&&i(e,r,t[r]);if(n)for(var r of n(t))a.call(t,r)&&i(e,r,t[r]);return e};import{_ as d}from"./index.b8f2284e.js";import{s as l}from"./side-effect-manager.es.3578cf95.js";import{e as c}from"./ensure-attributes.2c659353.js";import"./vendor.878c767b.js";const g=new WeakMap,u=new WeakMap,f=new WeakMap,p=Symbol("anyProducer"),b=Promise.resolve(),m=Symbol("listenerAdded"),h=Symbol("listenerRemoved");let y=!1;function v(e){if("string"!=typeof e&&"symbol"!=typeof e)throw new TypeError("eventName must be a string or a symbol")}function S(e){if("function"!=typeof e)throw new TypeError("listener must be a function")}function E(e,t){const r=u.get(e);return r.has(t)||r.set(t,new Set),r.get(t)}function w(e,t){const r="string"==typeof t||"symbol"==typeof t?t:p,n=f.get(e);return n.has(r)||n.set(r,new Set),n.get(r)}function P(e,t){t=Array.isArray(t)?t:[t];let r=!1,n=()=>{},s=[];const a={enqueue(e){s.push(e),n()},finish(){r=!0,n()}};for(const i of t)w(e,i).add(a);return{async next(){return s?0===s.length?r?(s=void 0,this.next()):(await new Promise((e=>{n=e})),this.next()):{done:!1,value:await s.shift()}:{done:!0}},async return(r){s=void 0;for(const n of t)w(e,n).delete(a);return n(),arguments.length>0?{done:!0,value:await r}:{done:!0}},[Symbol.asyncIterator](){return this}}}function I(e){if(void 0===e)return D;if(!Array.isArray(e))throw new TypeError("`methodNames` must be an array of strings");for(const t of e)if(!D.includes(t)){if("string"!=typeof t)throw new TypeError("`methodNames` element must be a string");throw new Error(`${t} is not Emittery method`)}return e}const x=e=>e===m||e===h;class A{static mixin(e,t){return t=I(t),r=>{if("function"!=typeof r)throw new TypeError("`target` must be function");for(const e of t)if(void 0!==r.prototype[e])throw new Error(`The property \`${e}\` already exists on \`target\``);Object.defineProperty(r.prototype,e,{enumerable:!1,get:function(){return Object.defineProperty(this,e,{enumerable:!1,value:new A}),this[e]}});const n=t=>function(...r){return this[e][t](...r)};for(const e of t)Object.defineProperty(r.prototype,e,{enumerable:!1,value:n(e)});return r}}static get isDebugEnabled(){if("object"!=typeof process)return y;const{env:e}=process||{env:{}};return"emittery"===e.DEBUG||"*"===e.DEBUG||y}static set isDebugEnabled(e){y=e}constructor(e={}){g.set(this,new Set),u.set(this,new Map),f.set(this,new Map),this.debug=e.debug||{},void 0===this.debug.enabled&&(this.debug.enabled=!1),this.debug.logger||(this.debug.logger=(e,t,r,n)=>{n=JSON.stringify(n),"symbol"==typeof r&&(r=r.toString());const s=new Date,a=`${s.getHours()}:${s.getMinutes()}:${s.getSeconds()}.${s.getMilliseconds()}`;console.log(`[${a}][emittery:${e}][${t}] Event Name: ${r}\n\tdata: ${n}`)})}logIfDebugEnabled(e,t,r){(A.isDebugEnabled||this.debug.enabled)&&this.debug.logger(e,this.debug.name,t,r)}on(e,t){S(t),e=Array.isArray(e)?e:[e];for(const r of e)v(r),E(this,r).add(t),this.logIfDebugEnabled("subscribe",r,void 0),x(r)||this.emit(m,{eventName:r,listener:t});return this.off.bind(this,e,t)}off(e,t){S(t),e=Array.isArray(e)?e:[e];for(const r of e)v(r),E(this,r).delete(t),this.logIfDebugEnabled("unsubscribe",r,void 0),x(r)||this.emit(h,{eventName:r,listener:t})}once(e){return new Promise((t=>{const r=this.on(e,(e=>{r(),t(e)}))}))}events(e){e=Array.isArray(e)?e:[e];for(const t of e)v(t);return P(this,e)}async emit(e,t){v(e),this.logIfDebugEnabled("emit",e,t),function(e,t,r){const n=f.get(e);if(n.has(t))for(const s of n.get(t))s.enqueue(r);if(n.has(p)){const e=Promise.all([t,r]);for(const t of n.get(p))t.enqueue(e)}}(this,e,t);const r=E(this,e),n=g.get(this),s=[...r],a=x(e)?[]:[...n];await b,await Promise.all([...s.map((async e=>{if(r.has(e))return e(t)})),...a.map((async r=>{if(n.has(r))return r(e,t)}))])}async emitSerial(e,t){v(e),this.logIfDebugEnabled("emitSerial",e,t);const r=E(this,e),n=g.get(this),s=[...r],a=[...n];await b;for(const i of s)r.has(i)&&await i(t);for(const i of a)n.has(i)&&await i(e,t)}onAny(e){return S(e),this.logIfDebugEnabled("subscribeAny",void 0,void 0),g.get(this).add(e),this.emit(m,{listener:e}),this.offAny.bind(this,e)}anyEvent(){return P(this)}offAny(e){S(e),this.logIfDebugEnabled("unsubscribeAny",void 0,void 0),this.emit(h,{listener:e}),g.get(this).delete(e)}clearListeners(e){e=Array.isArray(e)?e:[e];for(const t of e)if(this.logIfDebugEnabled("clear",t,void 0),"string"==typeof t||"symbol"==typeof t){E(this,t).clear();const e=w(this,t);for(const t of e)t.finish();e.clear()}else{g.get(this).clear();for(const e of u.get(this).values())e.clear();for(const e of f.get(this).values()){for(const t of e)t.finish();e.clear()}}}listenerCount(e){e=Array.isArray(e)?e:[e];let t=0;for(const r of e)if("string"!=typeof r){void 0!==r&&v(r),t+=g.get(this).size;for(const e of u.get(this).values())t+=e.size;for(const e of f.get(this).values())t+=e.size}else t+=g.get(this).size+E(this,r).size+w(this,r).size+w(this).size;return t}bindMethods(e,t){if("object"!=typeof e||null===e)throw new TypeError("`target` must be an object");t=I(t);for(const r of t){if(void 0!==e[r])throw new Error(`The property \`${r}\` already exists on \`target\``);Object.defineProperty(e,r,{enumerable:!1,value:this[r].bind(this)})}}}const D=Object.getOwnPropertyNames(A.prototype).filter((e=>"constructor"!==e));Object.defineProperty(A,"listenerAdded",{value:m,writable:!1,enumerable:!0,configurable:!1}),Object.defineProperty(A,"listenerRemoved",{value:h,writable:!1,enumerable:!0,configurable:!1});var k,M,O,R,j=A;function C(e){return Array(e).fill(0).map(((e,t)=>({name:String(t+1)})))}(M=k||(k={})).Init="Init",M.AttributesUpdate="AttributesUpdate",M.SetAttributes="SetAttributes",M.RegisterMagixEvent="RegisterMagixEvent",M.RemoveMagixEvent="RemoveMagixEvent",M.RemoveAllMagixEvent="RemoveAllMagixEvent",M.RoomStateChanged="RoomStateChanged",M.DispatchMagixEvent="DispatchMagixEvent",M.ReceiveMagixEvent="ReciveMagixEvent",M.NextPage="NextPage",M.PrevPage="PrevPage",M.SDKCreate="SDKCreate",M.OnCreate="OnCreate",M.SetPage="SetPage",M.GetAttributes="GetAttributes",M.Ready="Ready",M.Destroy="Destory",M.StartCreate="StartCreate",M.WrapperDidUpdate="WrapperDidUpdate",M.DisplayIframe="DisplayIframe",M.HideIframe="HideIframe",M.PageTo="PageTo",(R=O||(O={})).WrapperDidMount="WrapperDidMount",R.IframeLoad="IframeLoad";const L={kind:"IframeBridge",setup(e){const n=e.getBox(),s=e.getDisplayer(),a=e.getRoom(),i=c(e,{src:"about:blank",displaySceneDir:"/h5",lastEvent:null,state:{},page:0,pages:0,debug:!1});n.mountStyles(".netless-app-iframe-bridge{width:100%;height:100%}.netless-app-iframe-bridge iframe{width:100%;height:100%;border:0}.netless-app-iframe-bridge.readonly iframe{pointer-events:none}.netless-app-iframe-bridge-view{position:absolute;top:0;left:0;width:100%;height:100%}\n");const d=document.createElement("iframe"),g=function(...e){const t=document.createElement("div");return t.title="Netless App Iframe Bridge",t.classList.add("netless-app-iframe-bridge"),t.append(...e),t}(d);e.getInitScenePath()&&s.state.sceneState.contextPath!==i.displaySceneDir&&g.classList.add("readonly"),n.mountContent(g);const u=()=>s.state.sceneState.index+1,f=e=>{return n=o({},e),s={url:i.src,displaySceneDir:i.displaySceneDir,width:d.scrollWidth,height:d.scrollHeight,useClicker:!0,lastEvent:i.lastEvent},t(n,r(s));var n,s},p=new l,b=new j,m=new Map,h=()=>{m.forEach(((e,t)=>{s.removeMagixEventListener(t,e)})),m.clear()},y=(...e)=>i.debug&&console.log(...e),v=e=>{var t;y("[IframeBridge] postMessage %s %O",e.kind,e.payload),null==(t=d.contentWindow)||t.postMessage(JSON.parse(JSON.stringify(e)),"*")},S=(t,r)=>{e.getIsWritable()&&(e.updateAttributes(["lastEvent"],{name:t,payload:r}),y("[IframeBridge] dispatchMagixEvent %s %O",t,r),null==a||a.dispatchMagixEvent(t,r))},E=()=>{v({kind:k.Init,payload:{attributes:f(i.state),roomState:s.state,currentPage:u(),observerId:s.observerId}})};let w=!0;const P=e=>{E(),b.emit(O.IframeLoad,e),b.on(k.Ready,(()=>{var e;v(null==(e=i.lastEvent)?void 0:e.payload)})),w&&(setTimeout((()=>{v({kind:k.RoomStateChanged,payload:x(0)})}),500),w=!1),d.removeEventListener("load",P)};p.addEventListener(d,"load",P);let I=0;p.addEventListener(d,"error",(()=>{I++<3&&(d.src=i.src)})),d.src=i.src,p.add((()=>e.mobxUtils.autorun((()=>{v({kind:k.AttributesUpdate,payload:f(i.state)})})))),p.add((()=>e.mobxUtils.autorun((()=>{d.src=i.src}))));const x=(e=i.page)=>({sceneState:{sceneName:String(e),scenePath:`${i.displaySceneDir}/${e}`,contextPath:i.displaySceneDir,scenes:C(i.pages),index:e}});p.add((()=>e.mobxUtils.autorun((()=>{v({kind:k.RoomStateChanged,payload:x()})}))));const A={emitter:b,postMessage:v,context:e};b.emit(k.StartCreate),b.emit(k.OnCreate,A);const D=e=>{var t;(null==(t=null==e?void 0:e.sceneState)?void 0:t.scenePath.startsWith(i.displaySceneDir))?g.classList.remove("readonly"):g.classList.add("readonly")};p.add((()=>{const e=a?"onRoomStateChanged":"onPlayerStateChanged";return s.callbacks.on(e,D),()=>s.callbacks.off(e,D)}));const M=e.manager.appProxies.get(e.appId);return p.addEventListener(window,"message",(t=>{var r;if(t.source!==d.contentWindow)return;const n=t.data;switch(y("[IframeBridge] received",n.kind,n.payload),n.kind){case k.SetAttributes:e.updateAttributes(["state"],o(o({},i.state),n.payload));break;case k.RegisterMagixEvent:{const e=e=>{e.authorId!==s.observerId&&v({kind:k.ReceiveMagixEvent,payload:e})},t=n.payload;m.set(t,e),s.addMagixEventListener(t,e);break}case k.RemoveMagixEvent:{const e=n.payload,t=m.get(e);s.removeMagixEventListener(e,t);break}case k.DispatchMagixEvent:{const e=n.payload;S(e.event,e.payload);break}case k.RemoveAllMagixEvent:h();break;case k.NextPage:if(e.getIsWritable()&&a){const t=u()+1;if(t>s.state.sceneState.scenes.length)break;y("[IframeBridge] setSceneIndex",t-1),a.setSceneIndex(t-1),e.updateAttributes(["page"],t-1),S(k.NextPage,{})}break;case k.PrevPage:if(e.getIsWritable()&&a){const t=u()-1;if(t<0)return;y("[IframeBridge] setSceneIndex",t-1),a.setSceneIndex(t-1),e.updateAttributes(["page"],t-1),S(k.PrevPage,{})}break;case k.SDKCreate:E();break;case k.GetAttributes:v({kind:k.GetAttributes,payload:f(i.state)});break;case k.SetPage:{const t=n.payload,s=C(t);if(e.getIsWritable()&&a){const r=a.entireScenes()[i.displaySceneDir];r&&r.length===t||a.putScenes(i.displaySceneDir,s),a.setScenePath(i.displaySceneDir),y("[IframeBridge] SetPage",t),e.updateAttributes(["pages"],t)}(null==(r=M.scenes)?void 0:r.length)!==s.length&&(M.scenes=s);break}case k.PageTo:if(e.getIsWritable()&&a){const t=n.payload;if(!Number.isSafeInteger(t)||t<=0)break;a.setSceneIndex(t-1),e.updateAttributes(["page"],t-1),S(k.PageTo,t-1)}break;default:console.warn(`[IframeBridge]: unknown event kind "${n.kind}"`)}})),e.emitter.on("destroy",(()=>{console.log("[IframeBridge]: destroy"),b.emit(k.Destroy),p.flushAll(),h(),d.remove()})),A}};var N=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",get IframeEvents(){return k},get DomEvents(){return O},default:L});const $=[{kind:L.kind,src:()=>d((()=>Promise.resolve().then((function(){return N}))),void 0),options:{title:"demo"},attributes:{src:"/h5.html"}},...[{title:"cocos",src:"https://demo-edu.cocos.com/agora-demo/index.html"},{title:"chick",src:"https://demo-h5.netless.group/dist2020/"}].map((({title:e,src:t})=>({kind:L.kind,src:()=>d((()=>Promise.resolve().then((function(){return N}))),void 0),options:{title:e,scenePath:`/h5/${e}`,scenes:[]},attributes:{src:t,displaySceneDir:`/h5/${e}`}})))];export{$ as default};
