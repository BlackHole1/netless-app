var C=Object.defineProperty;var v=Object.getOwnPropertySymbols;var W=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable;var S=(e,n,a)=>n in e?C(e,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[n]=a,f=(e,n)=>{for(var a in n||(n={}))W.call(n,a)&&S(e,a,n[a]);if(v)for(var a of v(n))j.call(n,a)&&S(e,a,n[a]);return e};import{s as k}from"./side-effect-manager.es.5f289aa4.js";import{e as M}from"./ensure-attributes.2c659353.js";function w(e){return typeof e=="object"&&e!==null}const L=new Set(["clicker","selector"]),U={kind:"EmbeddedPage",setup(e){const n=e.getDisplayer(),a=e.getRoom(),P=e.getBox(),y=e.getView(),o=M(e,{src:"https://example.org",state:{},page:""}),d=new k,u=document.createElement("div");Object.assign(u.style,{width:"100%",height:"100%",position:"relative"});const c=document.createElement("iframe");Object.assign(c.style,{width:"100%",height:"100%",border:"none",display:"block"}),u.appendChild(c),P.mountContent(u);let b=()=>{};const h=t=>L.has(t);if(y){const t=document.createElement("div");Object.assign(t.style,{width:"100%",height:"100%",position:"absolute",top:0,left:0}),u.appendChild(t),e.mountView(t),b=s=>{t.style.pointerEvents=s?"none":"auto"},b(h(a==null?void 0:a.state.memberState.currentApplianceName))}const l=t=>{var s;(s=c.contentWindow)==null||s.postMessage(t,"*")},m=`channel-${e.appId}`,I=t=>{t.event===m&&t.authorId!==n.observerId&&l({type:"ReceiveMessage",payload:t.payload})};d.add(()=>(n.addMagixEventListener(m,I),()=>n.removeMagixEventListener(m))),a&&d.add(()=>{const t=s=>{s.memberState&&b(h(s.memberState.currentApplianceName))};return a.callbacks.on("onRoomStateChanged",t),()=>a.callbacks.off("onRoomStateChanged",t)}),d.addEventListener(c,"load",()=>{var i;const t=n.observerId,s=(i=n.state.roomMembers.find(r=>r.memberId===t))==null?void 0:i.payload;l({type:"Init",payload:{state:o.state,page:o.page,writable:e.getIsWritable(),meta:{roomUUID:a==null?void 0:a.uuid,userPayload:s&&JSON.parse(JSON.stringify(s))}}})}),d.addEventListener(window,"message",t=>{if(t.source!==c.contentWindow||!w(t.data))return;const{data:s}=t,i=s.type;if(console.log("[EmbeddedPage] receive",s),i==="GetState")l({type:"GetState",payload:o.state});else if(i==="SetState"){if(w(s.payload)&&e.getIsWritable())for(const[r,p]of Object.entries(s.payload))e.updateAttributes(["state",r],p)}else if(i==="GetPage")l({type:"GetPage",payload:o.page});else if(i==="SetPage")if(!y)console.warn("[EmbeddedPage] SetPage: page api is only available with 'scenePath'");else{const r=s.payload,p=e.getInitScenePath();if(typeof r=="string"&&e.getIsWritable()&&p&&a){const g=[p,r].join("/");a.scenePathType(g)==="none"&&a.putScenes(p,[{name:r}]),e.setScenePath(g),e.updateAttributes(["page"],r)}}else i==="GetWritable"?l({type:"GetWritable",payload:e.getIsWritable()}):i==="SendMessage"&&e.getIsWritable()&&(a==null||a.dispatchMagixEvent(m,s.payload))}),d.add(()=>{let t=f({},o.state);const s=r=>{const p={};for(const{key:g,value:E}of r)p[g]={oldValue:t[g],newValue:E};t=f({},o.state),l({type:"StateChanged",payload:p})},i=()=>e.objectUtils.listenUpdated(o.state,s);return e.mobxUtils.reaction(()=>o.state,i,{fireImmediately:!0})}),d.add(()=>{const t=(s,i)=>{l({type:"PageChanged",payload:{oldValue:i,newValue:s}})};return e.mobxUtils.reaction(()=>o.page,t)}),d.add(()=>{const t=()=>{const s=e.getIsWritable();l({type:"WritableChanged",payload:{oldValue:!s,newValue:s}})};return e.emitter.on("writableChange",t),()=>e.emitter.off("writableChange",t)}),c.src=o.src,e.emitter.on("destroy",()=>{console.log("[EmbeddedPage]: destroy"),d.flushAll()})}};export{U as default};
