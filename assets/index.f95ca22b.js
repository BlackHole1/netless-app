var W=Object.defineProperty;var D=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable,K=Reflect.get,T=Reflect.set;var P=(e,t,n)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,L=(e,t)=>{for(var n in t||(t={}))B.call(t,n)&&P(e,n,t[n]);if(D)for(var n of D(t))F.call(t,n)&&P(e,n,t[n]);return e};import{s as R}from"./side-effect-manager.es.5f289aa4.js";import{e as V}from"./ensure-attributes.2c659353.js";function G(){return new Worker("assets/fit-curve-worker.40493645.js",{type:"module"})}let $=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let r=n[e]&63;r<36?t+=r.toString(36):r<62?t+=(r-26).toString(36).toUpperCase():r<63?t+="_":t+="-"}return t};function O(){return new Worker("assets/bezier-q.c81898b8.js",{type:"module"})}function Q(){return document.createElementNS("http://www.w3.org/2000/svg","svg")}function C(){return document.createElementNS("http://www.w3.org/2000/svg","path")}function A(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}function U(e,t){const{left:n,top:r}=t.getBoundingClientRect();return{x:e.clientX-n|0,y:e.clientY-r|0}}const I=({x:e,y:t})=>`M${e},${t}`,S=({x:e,y:t})=>`L${e},${t}`,q=(e,{x:t,y:n})=>`Q${e.x},${e.y} ${t},${n}`,N=(e,t,{x:n,y:r})=>`C${e.x},${e.y} ${t.x},${t.y} ${n} ${r}`;class k{constructor(t){this.path=t}remove(){this.path.remove()}}class X extends k{replace(t){if(t.length<2)this.path.setAttribute("d","");else{const n=t.length-1;let r=I(t[0])+S(A(t[0],t[1]));for(let s=1;s<n;++s)r+=q(t[s],A(t[s],t[s+1]));r+=S(t[n]),this.path.setAttribute("d",r)}}}class Y extends k{replace(t){if(t.length<1)this.path.setAttribute("d","");else{const n=t.length-1;let r=I(t[0][0]);for(let s=0;s<=n;++s){const c=t[s];r+=N(c[1],c[2],c[3])}this.path.setAttribute("d",r)}}}const _=3,M=new O,x=new Map,z=()=>new Promise(e=>requestAnimationFrame(e));M.onmessage=e=>{const{id:t,points:n}=e.data,r=x.get(t);r&&r(n)};async function H(e,t){const n=e.newPath(),{length:r}=t;for(let s=2;s<r;++s)n.replace(t.slice(0,s)),await z();n.replace(t)}function J(e,t){t=t.map(r=>r.map(s=>L({},s)));const n=$();x.set(n,r=>H(e,r)),M.postMessage({id:n,curves:t,step:_})}class v{constructor(t,n,r){this.target=t,this.onDraw=n,this.onDrawEnd=r,this.currentPathUID="",this.pointerDown=s=>{s.isPrimary&&(this.currentPathUID=$(),this.onDraw(this.currentPathUID,U(s,this.target),s.timeStamp))},this.pointerMove=s=>{s.isPrimary&&this.currentPathUID&&this.onDraw(this.currentPathUID,U(s,this.target),s.timeStamp)},this.pointerUp=s=>{this.currentPathUID&&(this.onDrawEnd(this.currentPathUID,s.timeStamp),this.currentPathUID="")},t.addEventListener("pointerdown",this.pointerDown,!1),t.addEventListener("pointermove",this.pointerMove,!1),t.addEventListener("pointerup",this.pointerUp,!1),t.addEventListener("pointerleave",this.pointerUp,!1)}clear(){let t=null;for(;t=this.target.firstChild;)t.remove()}destroy(){this.target.removeEventListener("pointerdown",this.pointerDown,!1),this.target.removeEventListener("pointermove",this.pointerMove,!1),this.target.removeEventListener("pointerup",this.pointerUp,!1),this.target.removeEventListener("pointerleave",this.pointerUp,!1)}newPath(){const t=C();return this.target.append(t),new X(t)}newCurve(){const t=C();return this.target.append(t),new Y(t)}initCurves(t){for(const n of Object.values(t))this.newCurve().replace(n)}}v.createSVGElement=Q;const nt={kind:"Paint",setup(e){var b,y;const{appId:t}=e,n=e.getBox(),r=e.getRoom(),s=e.getDisplayer(),c=V(e,{curves:{}}),h=v.createSVGElement();h.setAttribute("fill","transparent"),h.setAttribute("stroke","#000"),h.setAttribute("stroke-width","2"),Object.assign(h.style,{display:"block",width:"100%",height:"100%"}),n.mountContent(h),(b=n.$content)==null||b.addEventListener("touchstart",i=>i.preventDefault()),(y=n.$content)==null||y.addEventListener("touchmove",i=>i.preventDefault());const g=new R,w=new G,u=`channel-${t}`,E=i=>{e.getIsWritable()&&(r==null||r.dispatchMagixEvent(u,i))},d={},j=i=>{if(i.event===u&&i.authorId!==s.observerId){const{clear:a,pid:p,done:o}=i.payload;a&&(l.clear(),l.initCurves(c.curves)),p&&o&&J(l,c.curves[p])}};g.add(()=>(s.addMagixEventListener(u,j),()=>s==null?void 0:s.removeMagixEventListener(u)));const l=new v(h,(i,a,p)=>{let o=d[i];o||(o=d[i]={points:[],path:l.newPath()}),o.points.push(a),o.path.replace(o.points),o.timeStamp=p},i=>{const a=d[i];!a||(a.points.length<2?a.path.remove():w.postMessage({id:i,path:a.points,error:5}),delete d[i])});l.initCurves(c.curves),w.onmessage=i=>{const{id:a,curves:p}=i.data;e.getIsWritable()&&(e.updateAttributes(["curves",a],p),E({pid:a,done:!0}))};const f=document.createElement("button");f.textContent="CLEAR ALL",f.addEventListener("click",()=>{l.clear(),e.updateAttributes(["curves"],{}),E({clear:!0})});const m=document.createElement("div");m.append(f),Object.assign(m.style,{display:"flex",justifyContent:"center"}),n.mountFooter(m),e.emitter.on("destroy",()=>{console.log("[Paint]: destroy"),g.flushAll(),l.destroy()})}};export{nt as default};
