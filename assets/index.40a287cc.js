var P=Object.defineProperty;var v=Object.getOwnPropertySymbols;var I=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var w=(e,n,t)=>n in e?P(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,u=(e,n)=>{for(var t in n||(n={}))I.call(n,t)&&w(e,t,n[t]);if(v)for(var t of v(n))k.call(n,t)&&w(e,t,n[t]);return e};import{s as E}from"./side-effect-manager.es.5f289aa4.js";import{e as C}from"./ensure-attributes.2c659353.js";function y(e){return typeof e=="object"&&e!==null}var W=`.netless-app-embedded-page{width:100%;height:100%;position:relative}.netless-app-embedded-page iframe{width:100%;height:100%;border:none;display:block}.netless-app-embedded-page-wb-view{width:100%;height:100%;position:absolute;top:0;left:0}
`;const M=new Set(["clicker","selector"]),G={kind:"EmbeddedPage",setup(e){const n=e.getDisplayer(),t=e.getRoom(),f=e.getBox(),m=e.getView(),o=C(e,{src:"https://example.org",state:{},page:""}),r=new E,p=document.createElement("div");p.dataset.appKind="EmbeddedPage",p.classList.add("netless-app-embedded-page");const c=document.createElement("iframe");if(p.appendChild(c),f.mountStyles(W),f.mountContent(p),m){const s=document.createElement("div");if(s.classList.add("netless-app-embedded-page-wb-view"),p.appendChild(s),e.mountView(s),t){const a=d=>{s.style.pointerEvents=!d||M.has(d)?"none":"auto"};a(t.state.memberState.currentApplianceName),r.add(()=>{const d=i=>{i.memberState&&a(i.memberState.currentApplianceName)};return t.callbacks.on("onRoomStateChanged",d),()=>t.callbacks.off("onRoomStateChanged",d)})}}const l=s=>{var a;(a=c.contentWindow)==null||a.postMessage(s,"*")},b=`channel-${e.appId}`;r.add(()=>{const s=a=>{a.event===b&&a.authorId!==n.observerId&&l({type:"ReceiveMessage",payload:a.payload})};return n.addMagixEventListener(b,s),()=>n.removeMagixEventListener(b)}),r.addEventListener(c,"load",()=>{var d;const s=n.observerId,a=(d=n.state.roomMembers.find(i=>i.memberId===s))==null?void 0:d.payload;l({type:"Init",payload:{state:o.state,page:o.page,writable:e.getIsWritable(),meta:{roomUUID:t==null?void 0:t.uuid,userPayload:a&&JSON.parse(JSON.stringify(a))}}})}),r.addEventListener(window,"message",s=>{if(s.source!==c.contentWindow||!y(s.data))return;const a=s.data;switch(console.log("[EmbeddedPage] receive",a),a.type){case"GetState":{l({type:"GetState",payload:o.state});break}case"SetState":{if(y(a.payload)&&e.getIsWritable())for(const[d,i]of Object.entries(a.payload))e.updateAttributes(["state",d],i);break}case"GetPage":{l({type:"GetPage",payload:o.page});break}case"SetPage":{if(!m)console.warn("[EmbeddedPage] SetPage: page api is only available with 'scenePath'");else{const d=a.payload,i=e.getInitScenePath();if(typeof d=="string"&&e.getIsWritable()&&i&&t){const g=[i,d].join("/");t.scenePathType(g)==="none"&&t.putScenes(i,[{name:d}]),e.setScenePath(g),e.updateAttributes(["page"],d)}}break}case"GetWritable":{l({type:"GetWritable",payload:e.getIsWritable()});break}case"SendMessage":{e.getIsWritable()&&t&&t.dispatchMagixEvent(b,a.payload);break}case"MoveCamera":{y(a.payload)&&m&&m.moveCamera({centerX:a.payload.x,centerY:a.payload.y,scale:a.payload.scale,animationMode:"immediately"});break}}}),r.add(()=>{let s=u({},o.state);const a=i=>{const g={};for(const{key:h,value:S}of i)g[h]={oldValue:s[h],newValue:S};s=u({},o.state),l({type:"StateChanged",payload:g})},d=()=>e.objectUtils.listenUpdated(o.state,a);return e.mobxUtils.reaction(()=>o.state,d,{fireImmediately:!0})}),r.add(()=>{const s=(a,d)=>{l({type:"PageChanged",payload:{oldValue:d,newValue:a}})};return e.mobxUtils.reaction(()=>o.page,s)}),r.add(()=>{let s=e.getIsWritable();const a=()=>{const d=e.getIsWritable();l({type:"WritableChanged",payload:{oldValue:s,newValue:d}}),s=d};return e.emitter.on("writableChange",a),()=>e.emitter.off("writableChange",a)}),c.src=o.src,e.emitter.on("destroy",()=>{console.log("[EmbeddedPage]: destroy"),r.flushAll()})}};export{G as default};
