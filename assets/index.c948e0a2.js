var te=Object.defineProperty,re=Object.defineProperties;var se=Object.getOwnPropertyDescriptors;var J=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable;var K=(t,e,r)=>e in t?te(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,D=(t,e)=>{for(var r in e||(e={}))ie.call(e,r)&&K(t,r,e[r]);if(J)for(var r of J(e))ne.call(e,r)&&K(t,r,e[r]);return t},F=(t,e)=>re(t,se(e));import{s as ae}from"./side-effect-manager.es.3578cf95.js";import{e as oe}from"./ensure-attributes.2c659353.js";const p=new WeakMap,x=new WeakMap,P=new WeakMap,O=Symbol("anyProducer"),Q=Promise.resolve(),I=Symbol("listenerAdded"),v=Symbol("listenerRemoved");let W=!1;function S(t){if(typeof t!="string"&&typeof t!="symbol")throw new TypeError("eventName must be a string or a symbol")}function R(t){if(typeof t!="function")throw new TypeError("listener must be a function")}function w(t,e){const r=x.get(t);return r.has(e)||r.set(e,new Set),r.get(e)}function E(t,e){const r=typeof e=="string"||typeof e=="symbol"?e:O,s=P.get(t);return s.has(r)||s.set(r,new Set),s.get(r)}function de(t,e,r){const s=P.get(t);if(s.has(e))for(const i of s.get(e))i.enqueue(r);if(s.has(O)){const i=Promise.all([e,r]);for(const d of s.get(O))d.enqueue(i)}}function V(t,e){e=Array.isArray(e)?e:[e];let r=!1,s=()=>{},i=[];const d={enqueue(n){i.push(n),s()},finish(){r=!0,s()}};for(const n of e)E(t,n).add(d);return{async next(){return i?i.length===0?r?(i=void 0,this.next()):(await new Promise(n=>{s=n}),this.next()):{done:!1,value:await i.shift()}:{done:!0}},async return(n){i=void 0;for(const u of e)E(t,u).delete(d);return s(),arguments.length>0?{done:!0,value:await n}:{done:!0}},[Symbol.asyncIterator](){return this}}}function X(t){if(t===void 0)return Y;if(!Array.isArray(t))throw new TypeError("`methodNames` must be an array of strings");for(const e of t)if(!Y.includes(e))throw typeof e!="string"?new TypeError("`methodNames` element must be a string"):new Error(`${e} is not Emittery method`);return t}const T=t=>t===I||t===v;class h{static mixin(e,r){return r=X(r),s=>{if(typeof s!="function")throw new TypeError("`target` must be function");for(const n of r)if(s.prototype[n]!==void 0)throw new Error(`The property \`${n}\` already exists on \`target\``);function i(){return Object.defineProperty(this,e,{enumerable:!1,value:new h}),this[e]}Object.defineProperty(s.prototype,e,{enumerable:!1,get:i});const d=n=>function(...u){return this[e][n](...u)};for(const n of r)Object.defineProperty(s.prototype,n,{enumerable:!1,value:d(n)});return s}}static get isDebugEnabled(){if(typeof process!="object")return W;const{env:e}=process||{env:{}};return e.DEBUG==="emittery"||e.DEBUG==="*"||W}static set isDebugEnabled(e){W=e}constructor(e={}){p.set(this,new Set),x.set(this,new Map),P.set(this,new Map),this.debug=e.debug||{},this.debug.enabled===void 0&&(this.debug.enabled=!1),this.debug.logger||(this.debug.logger=(r,s,i,d)=>{d=JSON.stringify(d),typeof i=="symbol"&&(i=i.toString());const n=new Date,u=`${n.getHours()}:${n.getMinutes()}:${n.getSeconds()}.${n.getMilliseconds()}`;console.log(`[${u}][emittery:${r}][${s}] Event Name: ${i}
	data: ${d}`)})}logIfDebugEnabled(e,r,s){(h.isDebugEnabled||this.debug.enabled)&&this.debug.logger(e,this.debug.name,r,s)}on(e,r){R(r),e=Array.isArray(e)?e:[e];for(const s of e)S(s),w(this,s).add(r),this.logIfDebugEnabled("subscribe",s,void 0),T(s)||this.emit(I,{eventName:s,listener:r});return this.off.bind(this,e,r)}off(e,r){R(r),e=Array.isArray(e)?e:[e];for(const s of e)S(s),w(this,s).delete(r),this.logIfDebugEnabled("unsubscribe",s,void 0),T(s)||this.emit(v,{eventName:s,listener:r})}once(e){return new Promise(r=>{const s=this.on(e,i=>{s(),r(i)})})}events(e){e=Array.isArray(e)?e:[e];for(const r of e)S(r);return V(this,e)}async emit(e,r){S(e),this.logIfDebugEnabled("emit",e,r),de(this,e,r);const s=w(this,e),i=p.get(this),d=[...s],n=T(e)?[]:[...i];await Q,await Promise.all([...d.map(async u=>{if(s.has(u))return u(r)}),...n.map(async u=>{if(i.has(u))return u(e,r)})])}async emitSerial(e,r){S(e),this.logIfDebugEnabled("emitSerial",e,r);const s=w(this,e),i=p.get(this),d=[...s],n=[...i];await Q;for(const u of d)s.has(u)&&await u(r);for(const u of n)i.has(u)&&await u(e,r)}onAny(e){return R(e),this.logIfDebugEnabled("subscribeAny",void 0,void 0),p.get(this).add(e),this.emit(I,{listener:e}),this.offAny.bind(this,e)}anyEvent(){return V(this)}offAny(e){R(e),this.logIfDebugEnabled("unsubscribeAny",void 0,void 0),this.emit(v,{listener:e}),p.get(this).delete(e)}clearListeners(e){e=Array.isArray(e)?e:[e];for(const r of e)if(this.logIfDebugEnabled("clear",r,void 0),typeof r=="string"||typeof r=="symbol"){w(this,r).clear();const s=E(this,r);for(const i of s)i.finish();s.clear()}else{p.get(this).clear();for(const s of x.get(this).values())s.clear();for(const s of P.get(this).values()){for(const i of s)i.finish();s.clear()}}}listenerCount(e){e=Array.isArray(e)?e:[e];let r=0;for(const s of e){if(typeof s=="string"){r+=p.get(this).size+w(this,s).size+E(this,s).size+E(this).size;continue}typeof s!="undefined"&&S(s),r+=p.get(this).size;for(const i of x.get(this).values())r+=i.size;for(const i of P.get(this).values())r+=i.size}return r}bindMethods(e,r){if(typeof e!="object"||e===null)throw new TypeError("`target` must be an object");r=X(r);for(const s of r){if(e[s]!==void 0)throw new Error(`The property \`${s}\` already exists on \`target\``);Object.defineProperty(e,s,{enumerable:!1,value:this[s].bind(this)})}}}const Y=Object.getOwnPropertyNames(h.prototype).filter(t=>t!=="constructor");Object.defineProperty(h,"listenerAdded",{value:I,writable:!1,enumerable:!0,configurable:!1});Object.defineProperty(h,"listenerRemoved",{value:v,writable:!1,enumerable:!0,configurable:!1});var ce=h,le=`.netless-app-iframe-bridge{width:100%;height:100%}.netless-app-iframe-bridge iframe{width:100%;height:100%;border:0}.netless-app-iframe-bridge.readonly iframe{pointer-events:none}.netless-app-iframe-bridge-view{position:absolute;top:0;left:0;width:100%;height:100%}
`;function Z(t){return Array(t).fill(0).map((e,r)=>({name:String(r+1)}))}function ue(){return document.createElement("iframe")}function fe(...t){const e=document.createElement("div");return e.title="Netless App Iframe Bridge",e.classList.add("netless-app-iframe-bridge"),e.append(...t),e}var c;(function(t){t.Init="Init",t.AttributesUpdate="AttributesUpdate",t.SetAttributes="SetAttributes",t.RegisterMagixEvent="RegisterMagixEvent",t.RemoveMagixEvent="RemoveMagixEvent",t.RemoveAllMagixEvent="RemoveAllMagixEvent",t.RoomStateChanged="RoomStateChanged",t.DispatchMagixEvent="DispatchMagixEvent",t.ReceiveMagixEvent="ReciveMagixEvent",t.NextPage="NextPage",t.PrevPage="PrevPage",t.SDKCreate="SDKCreate",t.OnCreate="OnCreate",t.SetPage="SetPage",t.GetAttributes="GetAttributes",t.Ready="Ready",t.Destroy="Destory",t.StartCreate="StartCreate",t.WrapperDidUpdate="WrapperDidUpdate",t.DisplayIframe="DisplayIframe",t.HideIframe="HideIframe",t.PageTo="PageTo"})(c||(c={}));var $;(function(t){t.WrapperDidMount="WrapperDidMount",t.IframeLoad="IframeLoad"})($||($={}));const he={kind:"IframeBridge",setup(t){const e=t.getBox(),r=t.getDisplayer(),s=t.getRoom(),i=oe(t,{src:"about:blank",displaySceneDir:"/h5",lastEvent:null,state:{},page:0,pages:0,debug:!1});e.mountStyles(le);const d=ue(),n=fe(d);t.getInitScenePath()&&r.state.sceneState.contextPath!==i.displaySceneDir&&n.classList.add("readonly"),e.mountContent(n);const u=()=>r.state.sceneState.index,L=()=>u()+1,_=()=>r.state.sceneState.scenes.length,C=a=>F(D({},a),{url:i.src,displaySceneDir:i.displaySceneDir,width:d.scrollWidth,height:d.scrollHeight,useClicker:!0,lastEvent:i.lastEvent}),f=new ae,y=new ce,M=new Map,B=()=>{M.forEach((a,l)=>{r.removeMagixEventListener(l,a)}),M.clear()},m=(...a)=>i.debug&&console.log(...a),g=a=>{var l;m("[IframeBridge] postMessage %s %O",a.kind,a.payload),(l=d.contentWindow)==null||l.postMessage(JSON.parse(JSON.stringify(a)),"*")},k=(a,l)=>{t.getIsWritable()&&(t.updateAttributes(["lastEvent"],{name:a,payload:l}),m("[IframeBridge] dispatchMagixEvent %s %O",a,l),s==null||s.dispatchMagixEvent(a,l))},j=()=>{g({kind:c.Init,payload:{attributes:C(i.state),roomState:r.state,currentPage:L(),observerId:r.observerId}})};let U=!0;const z=a=>{j(),y.emit($.IframeLoad,a),y.on(c.Ready,()=>{var l;g((l=i.lastEvent)==null?void 0:l.payload)}),U&&(setTimeout(()=>{g({kind:c.RoomStateChanged,payload:G(0)})},500),U=!1),d.removeEventListener("load",z)};f.addEventListener(d,"load",z);let N=0;const ee=()=>{N++<3&&(d.src=i.src)};f.addEventListener(d,"error",ee),d.src=i.src,f.add(()=>t.mobxUtils.autorun(()=>{g({kind:c.AttributesUpdate,payload:C(i.state)})})),f.add(()=>t.mobxUtils.autorun(()=>{d.src=i.src}));const G=(a=i.page)=>({sceneState:{sceneName:String(a),scenePath:`${i.displaySceneDir}/${a}`,contextPath:i.displaySceneDir,scenes:Z(i.pages),index:a}});f.add(()=>t.mobxUtils.autorun(()=>{g({kind:c.RoomStateChanged,payload:G()})}));const q={emitter:y,postMessage:g,context:t};y.emit(c.StartCreate),y.emit(c.OnCreate,q);const H=a=>{var l;((l=a==null?void 0:a.sceneState)==null?void 0:l.scenePath.startsWith(i.displaySceneDir))?n.classList.remove("readonly"):n.classList.add("readonly")};return f.add(()=>{const a=s?"onRoomStateChanged":"onPlayerStateChanged";return r.callbacks.on(a,H),()=>r.callbacks.off(a,H)}),f.addEventListener(window,"message",a=>{if(a.source!==d.contentWindow)return;const l=a.data;switch(m("[IframeBridge] received",l.kind,l.payload),l.kind){case c.SetAttributes:{t.updateAttributes(["state"],D(D({},i.state),l.payload));break}case c.RegisterMagixEvent:{const o=A=>{A.authorId!==r.observerId&&g({kind:c.ReceiveMagixEvent,payload:A})},b=l.payload;M.set(b,o),r.addMagixEventListener(b,o);break}case c.RemoveMagixEvent:{const o=l.payload,b=M.get(o);r.removeMagixEventListener(o,b);break}case c.DispatchMagixEvent:{const o=l.payload;k(o.event,o.payload);break}case c.RemoveAllMagixEvent:{B();break}case c.NextPage:{if(t.getIsWritable()&&s){const o=L()+1;if(o>_())break;m("[IframeBridge] setSceneIndex",o-1),s.setSceneIndex(o-1),t.updateAttributes(["page"],o-1),k(c.NextPage,{})}break}case c.PrevPage:{if(t.getIsWritable()&&s){const o=L()-1;if(o<0)return;m("[IframeBridge] setSceneIndex",o-1),s.setSceneIndex(o-1),t.updateAttributes(["page"],o-1),k(c.PrevPage,{})}break}case c.SDKCreate:{j();break}case c.GetAttributes:{g({kind:c.GetAttributes,payload:C(i.state)});break}case c.SetPage:{const o=l.payload,b=Z(o);if(t.getIsWritable()&&s){const A=s.entireScenes()[i.displaySceneDir];(!A||A.length!==o)&&s.putScenes(i.displaySceneDir,b),s.setScenePath(i.displaySceneDir),m("[IframeBridge] SetPage",o),t.updateAttributes(["pages"],o)}t.setScenes(b);break}case c.PageTo:{if(t.getIsWritable()&&s){const o=l.payload;if(!Number.isSafeInteger(o)||o<=0)break;s.setSceneIndex(o-1),t.updateAttributes(["page"],o-1),k(c.PageTo,o-1)}break}default:console.warn(`[IframeBridge]: unknown event kind "${l.kind}"`)}}),t.emitter.on("destroy",()=>{console.log("[IframeBridge]: destroy"),y.emit(c.Destroy),f.flushAll(),B(),d.remove()}),q}};export{$ as DomEvents,c as IframeEvents,he as default};
