import{s as M}from"./side-effect-manager.es.5f289aa4.js";import{e as x}from"./ensure-attributes.2c659353.js";function k(){return new Worker("assets/fit-curve-worker.40493645.js",{type:"module"})}let j=(e=21)=>{let t="",s=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let r=s[e]&63;r<36?t+=r.toString(36):r<62?t+=(r-26).toString(36).toUpperCase():r<63?t+="_":t+="-"}return t};function W(){return document.createElementNS("http://www.w3.org/2000/svg","svg")}function D(){return document.createElementNS("http://www.w3.org/2000/svg","path")}function L(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}function $(e,t){const{left:s,top:r}=t.getBoundingClientRect();return{x:e.clientX-s|0,y:e.clientY-r|0}}const C=({x:e,y:t})=>`M${e},${t}`,U=({x:e,y:t})=>`L${e},${t}`,B=(e,{x:t,y:s})=>`Q${e.x},${e.y} ${t},${s}`,R=(e,t,{x:s,y:r})=>`C${e.x},${e.y} ${t.x},${t.y} ${s} ${r}`;class A{constructor(t){this.path=t}remove(){this.path.remove()}}class V extends A{replace(t){if(t.length<2)this.path.setAttribute("d","");else{const s=t.length-1;let r=C(t[0])+U(L(t[0],t[1]));for(let n=1;n<s;++n)r+=B(t[n],L(t[n],t[n+1]));r+=U(t[s]),this.path.setAttribute("d",r)}}}class G extends A{replace(t){if(t.length<1)this.path.setAttribute("d","");else{const s=t.length-1;let r=C(t[0][0]);for(let n=0;n<=s;++n){const p=t[n];r+=R(p[1],p[2],p[3])}this.path.setAttribute("d",r)}}}class w{constructor(t,s,r){this.target=t,this.onDraw=s,this.onDrawEnd=r,this.currentPathUID="",this.pointerDown=n=>{n.isPrimary&&(this.currentPathUID=j(),this.onDraw(this.currentPathUID,$(n,this.target),n.timeStamp))},this.pointerMove=n=>{n.isPrimary&&this.currentPathUID&&this.onDraw(this.currentPathUID,$(n,this.target),n.timeStamp)},this.pointerUp=n=>{this.currentPathUID&&(this.onDrawEnd(this.currentPathUID,n.timeStamp),this.currentPathUID="")},t.addEventListener("pointerdown",this.pointerDown,!1),t.addEventListener("pointermove",this.pointerMove,!1),t.addEventListener("pointerup",this.pointerUp,!1),t.addEventListener("pointerleave",this.pointerUp,!1)}clear(){let t=null;for(;t=this.target.firstChild;)t.remove()}destroy(){this.target.removeEventListener("pointerdown",this.pointerDown,!1),this.target.removeEventListener("pointermove",this.pointerMove,!1),this.target.removeEventListener("pointerup",this.pointerUp,!1),this.target.removeEventListener("pointerleave",this.pointerUp,!1)}newPath(){const t=D();return this.target.append(t),new V(t)}newCurve(){const t=D();return this.target.append(t),new G(t)}initCurves(t){for(const s of Object.values(t))this.newCurve().replace(s)}}w.createSVGElement=W;const N={kind:"Paint",setup(e){var b,P;const{appId:t}=e,s=e.getBox(),r=e.getRoom(),n=e.getDisplayer(),p=x(e,{curves:{}}),u=w.createSVGElement();u.setAttribute("fill","transparent"),u.setAttribute("stroke","#000"),u.setAttribute("stroke-width","2"),Object.assign(u.style,{display:"block",width:"100%",height:"100%"}),s.mountContent(u),(b=s.$content)==null||b.addEventListener("touchstart",i=>i.preventDefault()),(P=s.$content)==null||P.addEventListener("touchmove",i=>i.preventDefault());const E=new M,y=new k,f=`channel-${t}`,m=i=>{e.getIsWritable()&&(r==null||r.dispatchMagixEvent(f,i))},l={},I=i=>{if(i.event===f&&i.authorId!==n.observerId){const{clear:a,pid:h,point:o,done:S}=i.payload;if(a&&(c.clear(),c.initCurves(p.curves)),h){let d=l[h];d||(d=l[h]={points:[],path:c.newPath()}),o&&(d.points.push(o),d.path.replace(d.points)),S&&delete l[h]}}};E.add(()=>(n.addMagixEventListener(f,I),()=>n==null?void 0:n.removeMagixEventListener(f)));const c=new w(u,(i,a,h)=>{let o=l[i];o||(o=l[i]={points:[],path:c.newPath()}),o.points.push(a),o.path.replace(o.points),o.timeStamp=h,m({pid:i,point:a})},i=>{const a=l[i];!a||(a.points.length<2?a.path.remove():y.postMessage({id:i,path:a.points,error:5}),delete l[i],m({pid:i,done:!0}))});c.initCurves(p.curves),y.onmessage=i=>{const{id:a,curves:h}=i.data;e.getIsWritable()&&e.updateAttributes(["curves",a],h)};const v=document.createElement("button");v.textContent="CLEAR ALL",v.addEventListener("click",()=>{c.clear(),e.updateAttributes(["curves"],{}),m({clear:!0})});const g=document.createElement("div");g.append(v),Object.assign(g.style,{display:"flex",justifyContent:"center"}),s.mountFooter(g),e.emitter.on("destroy",()=>{console.log("[Paint]: destroy"),E.flushAll(),c.destroy()})}};export{N as default};
